# åº§ä½åˆ‡æ¢è°ƒè¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨æ·»åŠ çš„è¯¦ç»†æ—¥å¿—æ¥è¯Šæ–­åº§ä½åˆ‡æ¢åŠŸèƒ½çš„é—®é¢˜ã€‚

## æ—¥å¿—ä½ç½®

### åç«¯æ—¥å¿—

1. **Socket Handler** (`backend/src/socket/socketHandler.js`)
   - ä½ç½®ï¼š`join_table` äº‹ä»¶å¤„ç†å‡½æ•°
   - æ—¥å¿—å‰ç¼€ï¼š`[join_table]`
   - åŒ…å«ï¼šå‚æ•°è§£æã€æˆ¿é—´æŸ¥æ‰¾ã€æ¡Œå­æŸ¥æ‰¾ã€åº§ä½æ£€æŸ¥ç­‰

2. **Battle Service** (`backend/src/services/battleService.js`)
   - ä½ç½®ï¼š`userJoinTable` æ–¹æ³•
   - æ—¥å¿—å‰ç¼€ï¼š`[userJoinTable]`
   - åŒ…å«ï¼šæ•°æ®åº“æ“ä½œã€åº§ä½åˆ‡æ¢é€»è¾‘ã€è·¨æ¡Œå­åˆ‡æ¢å¤„ç†ç­‰

### å‰ç«¯æ—¥å¿—

1. **Game Hall Page** (`frontend/src/pages/battle/GameHallPage.js`)
   - ä½ç½®ï¼š`handleSeatClick` æ–¹æ³•
   - æ—¥å¿—å‰ç¼€ï¼š`[handleSeatClick]`
   - åŒ…å«ï¼šç”¨æˆ·ç‚¹å‡»å¤„ç†ã€æœ¬åœ°çŠ¶æ€æ›´æ–°ã€socketäº‹ä»¶å‘é€ç­‰

2. **Socket Event Listeners** (åŒä¸€æ–‡ä»¶)
   - ä½ç½®ï¼šsocketäº‹ä»¶ç›‘å¬å™¨
   - æ—¥å¿—å‰ç¼€ï¼š`[join_table_success]`, `[join_table_failed]`, `[player_joined_table]`, `[player_left_table]`
   - åŒ…å«ï¼šæœåŠ¡å™¨å“åº”å¤„ç†ã€å‰ç«¯çŠ¶æ€æ›´æ–°ç­‰

## è°ƒè¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡å¹¶æŸ¥çœ‹æ—¥å¿—

```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd backend
npm start

# å¯åŠ¨å‰ç«¯æœåŠ¡
cd frontend
npm start
```

### 2. æ‰§è¡Œæµ‹è¯•

è¿è¡Œåº§ä½åˆ‡æ¢æµ‹è¯•è„šæœ¬ï¼š

```bash
# Windows
run-seat-test.bat

# æˆ–è€…ç›´æ¥è¿è¡Œ
node test-seat-switching.js
```

### 3. è§‚å¯Ÿæ—¥å¿—æµç¨‹

#### å‰ç«¯ç‚¹å‡»åº§ä½æ—¶çš„æ—¥å¿—æµç¨‹ï¼š

```
=== [handleSeatClick] å¼€å§‹å¤„ç†åº§ä½ç‚¹å‡» ===
ğŸ“¥ ç‚¹å‡»å‚æ•°: { tableId: 1, seatNumber: 1 }
ğŸ“¥ å½“å‰ç”¨æˆ·ä¿¡æ¯: { user: 1, isAuthenticated: true }
ğŸ“¥ å½“å‰é€‰ä¸­æˆ¿é—´: 1
ğŸ” æ‰¾åˆ°æˆ¿é—´: { id: 1, room_id: 'room_1', name: 'ä¿„ç½—æ–¯æ–¹å—æˆ¿é—´1' }
ğŸ” å½“å‰æ¡Œå­ä¿¡æ¯: { id: 1, seats: {...}, currentPlayers: 0 }
ğŸ” åº§ä½åˆ‡æ¢æ£€æŸ¥: { existingSeat: null, isSeatSwitch: false, isTableSwitch: false }
ğŸ”§ å‡†å¤‡å‘é€socketäº‹ä»¶: { tableId: 1, roomId: 1, seatNumber: 1, userId: 1, username: 'testuser1' }
ğŸ”§ socketè¿æ¥çŠ¶æ€: { isConnected: true, reconnectAttempts: 0, maxReconnectAttempts: 5 }
âœ… socketäº‹ä»¶å·²å‘é€
ğŸ”„ æ›´æ–°æœ¬åœ°çŠ¶æ€...
ğŸ”„ æ›´æ–°æ¡Œå­ 1: { åŸåº§ä½çŠ¶æ€: {...}, æ–°åº§ä½çŠ¶æ€: {...}, åŸç©å®¶æ•°: 0, æ–°ç©å®¶æ•°: 1 }
âœ… æœ¬åœ°çŠ¶æ€æ›´æ–°å®Œæˆ
âœ… æœ¬åœ°æ“ä½œå®Œæˆï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
=== [handleSeatClick] å¤„ç†å®Œæˆ ===
```

#### åç«¯å¤„ç†è¯·æ±‚æ—¶çš„æ—¥å¿—æµç¨‹ï¼š

```
=== [join_table] å¼€å§‹å¤„ç†å‰ç«¯è¯·æ±‚ ===
ğŸ“¥ æ”¶åˆ°å‰ç«¯å‚æ•°: { tableId: 1, roomId: 1, seatNumber: 1, userId: 1, username: 'testuser1' }
ğŸ“¥ å‚æ•°ç±»å‹: { tableId: 'number', roomId: 'number', seatNumber: 'number', userId: 'number' }
ğŸ”§ è§£æåçš„å‚æ•°: { parsedTableId: 1, parsedRoomId: 1, parsedSeatNumber: 1 }
ğŸ” å¼€å§‹æŸ¥æ‰¾æˆ¿é—´...
ğŸ” é€šè¿‡ä¸»é”®æŸ¥æ‰¾æˆ¿é—´ç»“æœ: æ‰¾åˆ°æˆ¿é—´ ä¿„ç½—æ–¯æ–¹å—æˆ¿é—´1 (ID: 1)
[join_table] âœ… æ‰¾åˆ°æˆ¿é—´: ä¿„ç½—æ–¯æ–¹å—æˆ¿é—´1 (ID: 1, room_id: room_1)
ğŸ” å¼€å§‹æŸ¥æ‰¾æ¡Œå­...
[join_table] âœ… æ‰¾åˆ°æ¡Œå­: { id: 1, table_id: 1, room_id: 1, current_players: 0, status: 'empty' }
[join_table] ğŸ” æ£€æŸ¥åº§ä½å­—æ®µ: seat_1_user_id
[join_table] ğŸ” åº§ä½å½“å‰å€¼: null
[join_table] ğŸ” å½“å‰ç”¨æˆ·ID: 1
ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœ¨å…¶ä»–åº§ä½...
[join_table] ğŸ” ç”¨æˆ·å½“å‰åº§ä½æ£€æŸ¥ç»“æœ: null
[join_table] ğŸ”§ è°ƒç”¨userJoinTable...
[join_table] ğŸ”§ userJoinTableå‚æ•°: { userId: 1, tableId: 1, seatNumber: 1 }
```

#### Battle Serviceå¤„ç†æ—¶çš„æ—¥å¿—æµç¨‹ï¼š

```
=== [userJoinTable] å¼€å§‹å¤„ç†ç”¨æˆ·åŠ å…¥æ¡Œå­ ===
ğŸ“¥ è¾“å…¥å‚æ•°: { userId: 1, tableId: 1, seatNumber: 1 }
ğŸ”§ ç”¨æˆ· 1 åŠ å…¥æ¡Œå­ 1 åº§ä½ 1
ğŸ“Š æ¡Œå­å½“å‰çŠ¶æ€: { id: 1, table_id: 1, room_id: 1, current_players: 0, status: 'empty', seat_1_user_id: null, seat_2_user_id: null, seat_3_user_id: null, seat_4_user_id: null }
ğŸ” æ£€æŸ¥åº§ä½å­—æ®µ: seat_1_user_id, å½“å‰å€¼: null
ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœ¨åŒä¸€å¼ æ¡Œå­çš„å…¶ä»–åº§ä½...
ğŸ” ç”¨æˆ·åœ¨åŒä¸€å¼ æ¡Œå­çš„åº§ä½æ£€æŸ¥ç»“æœ: null
ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…¶ä»–æ¡Œå­ä¸­...
ğŸ” ç”¨æˆ·å½“å‰æ¡Œå­ä¿¡æ¯: null
ğŸ”§ æ›´æ–°æ¡Œå­æ•°æ®: { seat_1_user_id: 1, current_players: 1, status: 'empty' }
âœ… æ¡Œå­æ›´æ–°æˆåŠŸ
ğŸ”§ æ›´æ–°ç”¨æˆ·çŠ¶æ€: { user_id: 1, room_id: 1, table_id: 1, seat_number: 1, status: 'waiting', last_activity: 2024-01-20T10:30:00.000Z }
âœ… ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ: ç”¨æˆ· 1 åœ¨æˆ¿é—´ 1 æ¡Œå­ 1 åº§ä½ 1
âœ… userJoinTableæ‰§è¡Œå®Œæˆï¼Œè¿”å›ç»“æœ: { success: true, table: {...}, isSeatSwitch: false, isTableSwitch: false, oldSeat: null, oldTableInfo: null }
=== [userJoinTable] å¤„ç†å®Œæˆ ===
```

#### å‰ç«¯æ¥æ”¶å“åº”æ—¶çš„æ—¥å¿—æµç¨‹ï¼š

```
=== [join_table_success] æ”¶åˆ°æœåŠ¡å™¨æˆåŠŸå“åº” ===
ğŸ“¥ æœåŠ¡å™¨è¿”å›æ•°æ®: { tableId: 1, seatNumber: 1, userId: 1, username: 'testuser1', isSeatSwitch: false, isTableSwitch: false, oldSeat: null, oldTableInfo: null }
ğŸ”„ å¼€å§‹æ›´æ–°å‰ç«¯çŠ¶æ€...
ğŸ“Š å½“å‰å‰ç«¯çŠ¶æ€: [{ id: 1, seats: { 1: 1, 2: null, 3: null, 4: null }, currentPlayers: 1 }]
ğŸ”„ å¤„ç†å½“å‰æ¡Œå­ 1 çš„æ›´æ–°
âœ… å½“å‰æ¡Œå­æ›´æ–°å®Œæˆ: { åŸåº§ä½: { 1: 1, 2: null, 3: null, 4: null }, æ–°åº§ä½: { 1: 1, 2: null, 3: null, 4: null }, åŸç©å®¶æ•°: 1, æ–°ç©å®¶æ•°: 1, æ˜¯å¦åº§ä½åˆ‡æ¢: false, æ˜¯å¦è·¨æ¡Œå­åˆ‡æ¢: false }
âœ… å‰ç«¯çŠ¶æ€æ›´æ–°å®Œæˆ
```

## å¸¸è§é—®é¢˜è¯Šæ–­

### 1. åº§ä½åˆ‡æ¢ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥ç‚¹ï¼š**
- åç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `isSeatSwitch: true` æˆ– `isTableSwitch: true`
- å‰ç«¯æ—¥å¿—ä¸­æ˜¯å¦æ­£ç¡®å¤„ç†äº† `oldSeat` å’Œ `oldTableInfo`
- æ•°æ®åº“æ›´æ–°æ˜¯å¦æˆåŠŸï¼ˆæŸ¥çœ‹SQLæ‰§è¡Œæ—¥å¿—ï¼‰

### 2. åº§ä½çŠ¶æ€ä¸ä¸€è‡´

**æ£€æŸ¥ç‚¹ï¼š**
- å‰ç«¯æœ¬åœ°çŠ¶æ€æ›´æ–°æ˜¯å¦æ­£ç¡®
- åç«¯å¹¿æ’­äº‹ä»¶æ˜¯å¦æ­£ç¡®å‘é€
- å…¶ä»–å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®æ¥æ”¶å¹¶æ›´æ–°çŠ¶æ€

### 3. è·¨æ¡Œå­åˆ‡æ¢å¤±è´¥

**æ£€æŸ¥ç‚¹ï¼š**
- åç«¯æ˜¯å¦æ­£ç¡®è¯†åˆ«äº†è·¨æ¡Œå­åˆ‡æ¢ï¼ˆ`isTableSwitch: true`ï¼‰
- åŸæ¡Œå­çš„åº§ä½æ˜¯å¦æ­£ç¡®é‡Šæ”¾
- æ–°æ¡Œå­çš„åº§ä½æ˜¯å¦æ­£ç¡®å ç”¨

### 4. æ•°æ®åº“çŠ¶æ€å¼‚å¸¸

**æ£€æŸ¥ç‚¹ï¼š**
- æŸ¥çœ‹SQLæ‰§è¡Œæ—¥å¿—ï¼Œç¡®è®¤æ›´æ–°è¯­å¥æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ `battle_tables` è¡¨ä¸­çš„åº§ä½å­—æ®µæ˜¯å¦æ­£ç¡®è®¾ç½®ä¸ºNULL
- æ£€æŸ¥ `user_status` è¡¨ä¸­çš„ç”¨æˆ·çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°

## æµ‹è¯•è„šæœ¬ä½¿ç”¨

è¿è¡Œæµ‹è¯•è„šæœ¬å¯ä»¥è‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—åº§ä½åˆ‡æ¢æ“ä½œï¼š

```bash
node test-seat-switching.js
```

æµ‹è¯•æ­¥éª¤ï¼š
1. è¿æ¥socket
2. åŠ å…¥æ¡Œå­1åº§ä½1
3. åˆ‡æ¢åˆ°æ¡Œå­1åº§ä½2ï¼ˆåŒæ¡Œå­åˆ‡æ¢ï¼‰
4. åˆ‡æ¢åˆ°æ¡Œå­2åº§ä½1ï¼ˆè·¨æ¡Œå­åˆ‡æ¢ï¼‰
5. åˆ‡æ¢å›æ¡Œå­1åº§ä½1ï¼ˆè·¨æ¡Œå­åˆ‡æ¢ï¼‰

## æ—¥å¿—çº§åˆ«

- `ğŸ“¥` - è¾“å…¥æ•°æ®
- `ğŸ“¤` - è¾“å‡ºæ•°æ®
- `ğŸ”§` - å¤„ç†è¿‡ç¨‹
- `ğŸ”` - æ£€æŸ¥/æŸ¥æ‰¾
- `âœ…` - æˆåŠŸ
- `âŒ` - å¤±è´¥/é”™è¯¯
- `ğŸ”„` - çŠ¶æ€æ›´æ–°
- `ğŸ‘¤` - å…¶ä»–ç”¨æˆ·æ“ä½œ

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿åç«¯å’Œå‰ç«¯æœåŠ¡éƒ½åœ¨è¿è¡Œ
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
3. ç¡®ä¿socketè¿æ¥æˆåŠŸå»ºç«‹
4. æ³¨æ„æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ï¼Œç¡®è®¤æ“ä½œé¡ºåº
5. å¦‚æœå‘ç°é—®é¢˜ï¼Œå¯ä»¥å¯¹æ¯”å‰åç«¯æ—¥å¿—ï¼Œæ‰¾å‡ºä¸ä¸€è‡´çš„åœ°æ–¹ 